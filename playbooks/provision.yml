---

- name: BigIP F5 provisioning
  hosts: localhost
  connection: local
  gather_facts: no
  
  tasks:
    - include_vars: ../defaults/main.yml

    - name: Create F5 Nodes
      bigip_node:
        provider: "{{ f5_provider }}"
        host: "{{ item.host }}"
        name: "{{ item.name }}"
      loop: "{{ nodes }}"

    - name: Create F5 Pools
      bigip_pool: 
        provider: "{{ f5_provider }}"
        name: "{{ item.name }}"
        lb_method: "{{ item-lb_method }}"
        monitors: "{{ item.monitors }}"
        monitor_type: "{{ item.monitor_type }}"
        state: present
      notify: save config
      loop: "{{ pools }}"

    - name: Add Pool Members
      bigip_pool_member:
        provider: "{{ f5_provider }}"
        port: "{{ item.port }}"
        host: "{{ item.host }}"
        name: "{{ item.name }}"
        name: "{{ item.pool }}"
      loop: "{{ pool_members }}"
      notify: save config

    - name: Add Virtual Server
      bigip_virtual_server:
        provider: "{{ f5_provider }}"
        name: "vip"
        destination: "{{ f5_provider.server }}"
        port: "443"
        enabled_vlans: "all"
        all_profiles: ['http','clientssl']
        pool: www_pool
        snat: "Automap"
      notify: save config
      register: vservercache

    - name: Delay after virtual server changed
      wait_for:
        timeout: 5
      when: vservercache.changed


